<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Firebase Connection Doctor</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            line-height: 1.5;
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- FONT CH? M?I: ROBOTO (H? tr? Ti?ng Vi?t) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- FONT CH? M?I: ARIAL (Chu?n hóa h? th?ng) -->
    <style>
        /* Áp d?ng font Roboto cho toàn b? các th? trên trang web */
        /* Áp d?ng font Arial cho toàn b? các th? trên trang web */
        body, h1, h2, h3, h4, h5, h6, p, span, div, a, li, ul, ol, td, th, input, button, select, textarea, i, b, strong, em {
            font-family: 'Roboto', sans-serif !important;
            font-family: Arial, Helvetica, sans-serif !important;
            line-height: 1.5;
        }
    </style>

</head>

<body>
    <h1>Firebase Connection Doctor</h1>
    <button onclick="runTest()">CHáº Y KIá»‚M TRA (RUN TEST)</button>
    <div id="status" class="log">Ready to test...</div>

    <!-- FIREBASE SDK -->
    
    
    

    <script>
        function log(msg, type = '') {
            const el = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `\n<span class="${type}">[${time}] ${msg}</span>`;
        }

        async function runTest() {
            document.getElementById('status').innerHTML = 'Starting test...';

            // 1. Check Config
            if (typeof firebaseConfig === 'undefined') {
                log("CRITICAL: firebaseConfig not found!", 'error');
                return;
            }
            log("Config found for project: " + firebaseConfig.projectId);

            // 2. Check Init
            if (!firebase.apps.length) {
                log("Initializing Firebase...", 'success');
                firebase.initializeApp(firebaseConfig);
            } else {
                log("Firebase already initialized.");
            }

            const db = firebase.firestore();

            // 3. Network Ping (REST)
            log("Attempting REST API Ping (Checking Internet & API Status)...");
            try {
                // Try to list documents in root (will likely fail auth, but checking network reachability)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout

                const response = await fetch(`https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                log(`REST Ping Result: ${response.status} ${response.statusText}`);
                if (response.ok) {
                    log("SUCCESS: Cloud Firestore API is REACHABLE and ENABLED.", 'success');
                } else if (response.status === 403) {
                    log("WARNING: API Reachable but Access Denied (Auth/Rules). This is expected if Rules are private.", 'error');
                } else {
                    log("ERROR: API might be disabled or errored.", 'error');
                }
            } catch (e) {
                log("NETWORK ERROR: Could not reach Google Servers. Check internet/firewall.\n" + e.message, 'error');
            }

            // 4. Firestore SDK Write Test
            log("Attempting Firestore SDK Write (Testing Permissions)...");
            try {
                await db.collection('_diagnostics').doc('test').set({
                    time: new Date().toISOString(),
                    agent: navigator.userAgent
                });
                log("SUCCESS: Write operation completed!", 'success');
                log("Your connection and rules are working perfectly.", 'success');
            } catch (e) {
                log("WRITE FAILED: " + e.message, 'error');
                if (e.code === 'permission-denied') {
                    log("\n[!] PERMISSION DENIED EXPLAINED:", 'error');
                    log("Your Security Rules are blocking access. Since you are not using Firebase Auth, you MUST set rules to Public (Test Mode).", 'error');
                    log("ACTION: Go to Firebase Console -> Firestore Database -> Rules and change to 'allow read, write: if true;'");
                } else if (e.code === 'unavailable' || e.message.includes('offline')) {
                    log("\n[!] OFFLINE/UNAVAILABLE EXPLAINED:", 'error');
                    log("Client cannot connect. Causes:\n1. Firewall/Proxy blocking\n2. API not enabled (check Cloud Console)\n3. Internet connection unstable");
                }
            }
        }
    </script>
<script src="fix_text.js"></script>
</body>

</html>

